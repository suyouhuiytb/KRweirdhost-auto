name: WeirdHost 韩国节点强制续期（最终成功版）

on:
  workflow_dispatch:
  schedule:
    - cron: '0 15 * * *'    # 韩国时间 00:00

jobs:
  renew:
    runs-on: macos-14
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: 安装 v2ray（手动下载最新版）
        run: |
          curl -L -o /tmp/v2ray.zip https://github.com/v2fly/v2ray-core/releases/latest/download/v2ray-macos-64.zip
          unzip -q /tmp/v2ray.zip -d /tmp/v2ray

      - name: 启动韩国 vless（同时开 socks5 + http 代理）
        run: |
          cat > /tmp/vless.json << 'EOF'
          {
            "inbounds": [
              { "port": 10809, "listen": "127.0.0.1", "protocol": "socks", "settings": {"udp": true} },
              { "port": 10808, "listen": "127.0.0.1", "protocol": "http" }
            ],
            "outbounds": [{
              "protocol": "vless",
              "settings": {
                "vnext": [{
                  "address": "104.16.250.251",
                  "port": 443,
                  "users": [{ "id": "8351d6b4-32b9-4dfd-9b58-592fc9ed90ba", "encryption": "none" }]
                }]
              },
              "streamSettings": {
                "network": "ws",
                "security": "tls",
                "tlsSettings": {"serverName": "krr.guizilaban.dpdns.org"},
                "wsSettings": {
                  "path": "/vless-argo?ed=2560",
                  "headers": {"Host": "krr.guizilaban.dpdns.org"}
                }
              }
            }]
          }
          EOF
          nohup /tmp/v2ray/v2ray run -c /tmp/vless.json > /tmp/v2ray.log 2>&1 &
          sleep 10
          curl -x http://127.0.0.1:10808 https://ip.gs || echo "代理失败"

      - name: 安装 Playwright
        run: |
          pip3 install --break-system-packages playwright httpx
          playwright install --with-deps chromium

      - name: 执行续期（强制走韩国 http 代理）
        env:
          WH_USERNAME: ${{ secrets.WH_USERNAME }}
          WH_PASSWORD: ${{ secrets.WH_PASSWORD }}
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID:   ${{ secrets.TG_CHAT_ID }}
        run: |
          /opt/homebrew/bin/chromium-browser \
            --headless=new \
            --no-sandbox \
            --disable-gpu \
            --proxy-server=http://127.0.0.1:10808 \
            --user-data-dir=/tmp/chrome-profile \
            --window-size=1400,900 \
            --lang=ko-KR \
            --load-extension=/tmp/empty \
            --disable-extensions-except=/tmp/empty \
            --run-all-compositor-stages-before-draw \
            --disable-features=TranslateUI \
            --blink-settings=imagesEnabled=false \
            "data:text/html,<script>document.title='READY'</script>" || true

          python3 renew.py
